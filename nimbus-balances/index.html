<!DOCTYPE html><meta charset="utf-8">
<title>Nimbus 多协议余额查询</title>
<style>
body{font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif;padding:24px;max-width:880px;margin:auto}
h2{margin:0 0 12px;font-size:1.3rem}
textarea{width:100%;height:100px;font-family:monospace}
button{padding:8px 18px;margin:12px 0}
table{width:100%;border-collapse:collapse;font-size:.9rem;margin-top:10px}
th,td{border:1px solid #d0d0d0;padding:6px;text-align:center}
.ok{color:#16a34a;font-weight:600}.err{color:#dc2626;font-weight:600}
tfoot td{font-weight:700}
</style>

<h2>Nimbus 多协议余额查询</h2>
<textarea id="addr" placeholder="输入 Eclipse/Solana base58 地址（每行一个）"></textarea>
<button id="run">开始查询</button>
<p id="log">等待输入…</p>

<table>
  <thead><tr><th>#</th><th>地址</th><th>协议</th><th>现值 USD</th><th>状态</th></tr></thead>
  <tbody id="tbody"></tbody>
  <tfoot><tr><td colspan="3">总和</td><td id="sum">$0</td><td></td></tr></tfoot>
</table>

<script>
/* --------- 可按需增删的协议列表 --------- */
const PROTOCOLS = [
  "Astrol",
  "SolarDex",
  "Sandglass",
  "Umbra",
  "PortalFinance",
  "ECLIPSE-Save",
  "ECLIPSE-Invariant",
  "ECLIPSE-Orca"
];

const API     = "https://api.getnimbus.io/v2/address/";
const SLEEP   = 600;                                // ms，防 429
const REG_B58 = /^[1-9A-HJ-NP-Za-km-z]{32,44}$/;    // Eclipse/Solana base58

async function fetchJSON(u){
  const r = await fetch(u);
  if(!r.ok) throw new Error(r.statusText || r.status);
  return r.json();
}

/* 拉某地址+协议的当前 USD 价值 */
async function getValue(addr, proto){
  const url = `${API}${addr}/positions?chain=Eclipse&protocol=${encodeURIComponent(proto)}`;
  const {data=[]} = await fetchJSON(url);
  return data.reduce((s,p)=>
    s + (p.current?.tokens ?? []).reduce((t,v)=>t + Number(v.value || 0), 0)
  ,0);
}

document.getElementById('run').onclick = async ()=>{
  const raw   = document.getElementById('addr').value.split(/\s+/).map(t=>t.trim());
  const addrs = [...new Set(raw.filter(a=>REG_B58.test(a)))];
  if(!addrs.length) return alert("请至少输入一个有效的 Eclipse/Solana 地址");

  const tbody = document.getElementById('tbody'); tbody.innerHTML="";
  const log   = document.getElementById('log');
  let grand   = 0, row = 0;

  for(const a of addrs){
    let addrSum = 0;
    for(const p of PROTOCOLS){
      row++;
      const tr = document.createElement('tr'); tbody.appendChild(tr);
      tr.innerHTML = `<td>${row}</td><td>${a}</td><td>${p}</td><td>加载中…</td><td></td>`;
      try{
        const val = await getValue(a, p);
        if(val > 0){
          addrSum += val; grand += val;
          tr.cells[3].textContent = `$${val.toLocaleString()}`;
          tr.cells[4].innerHTML   = '<span class="ok">✅</span>';
        }else{
          tr.cells[3].textContent = '$0';
          tr.cells[4].textContent = '-';
        }
      }catch(e){
        tr.cells[3].textContent = '-';
        tr.cells[4].innerHTML   = '<span class="err">❌</span>';
      }
      if(row < addrs.length * PROTOCOLS.length) await new Promise(r=>setTimeout(r,SLEEP));
    }
    /* 每个地址的小计行 */
    const sumTR = document.createElement('tr');
    sumTR.innerHTML =
      `<td></td><td colspan="2" style="text-align:right;font-weight:700">地址小计</td>` +
      `<td style="font-weight:700">$${addrSum.toLocaleString()}</td><td></td>`;
    tbody.appendChild(sumTR);
  }
  document.getElementById('sum').textContent = `$${grand.toLocaleString()}`;
  log.textContent = '完成 ✅';
};
</script>
